# Message Queue

## 목차
1. 메세지 지향 미들웨어
2. 메세지 큐
3. 메세지 브로커와 이벤트 브로커
4. 메시지 큐의 종류

# 1. 메세지 지향 미들웨어(MOM)

> 메세지 지향 미들웨어(Message-Oriented Middleware)는 응용 소프트웨어 간의 비동기적 데이터 통신을 위한 미들웨어 소프트웨어

- 프로세스 간 데이터를 비동기 방식으로 주고받도록 지원
- 메시지를 **임시 저장(보관)**하거나, 라우팅 및 변환할 수 있음
- 송신자와 수신자가 동시에 연결되어 있을 필요가 없음
- 다양한 서비스 간에 느슨한 결합(loose coupling) 을 제공해 유지보수와 확장에 유리
- 내결함성(fault tolerance): 장애 발생 시에도 메시지를 유실하지 않고 재처리 가능
- 소비자 수 증가에 따라 수평 확장성이 우수

### 메세지 큐는 이러한 MOM의 구현체 중 하나

# 2. 메세지 큐

> 메세지 큐는 비동기적으로 데이터를 전달하는 시스템으로, 생산자(Producer) 와 소비자(Consumer) 간의 중개 역할을 수행

- 큐(Queue) 자료구조 기반: 선입선출(FIFO) 방식으로 메시지를 처리
- 메시지를 큐에 일시 저장해, 소비자가 처리 가능한 시점에 가져가도록 함
- 시스템 부하 분산, 안정성 확보, 서비스 간 독립성 보장
- 메시지 처리 속도 차이, 장애 복구, 재처리 등 상황에 대응 가능
- 대표 구성 요소:
  - Producer: 메시지를 생성하여 큐에 보냄
  - Queue (Broker): 메시지를 임시 저장
  - Consumer: 메시지를 꺼내어 처리
 
## 장점
1. 비동기(Asynchronous): Queue에 넣어두기 때문에 나중에 처리할 수 있음
2. 낮은 결합도(Decoupling): 애플리케이션과 분리할 수 있음
3. 탄력성(Resilience): 일부가 실패 시 전체에 영향을 받지 않음
4. 과잉(Redundancy): 실패 할 경우 재실행이 가능
5. 신뢰성(Guarantees): 작업이 처리된 걸 확인할 수 있음
6. 확장성(Scalable): 다수의 프로세스들이 큐에 메시지를 보낼 수 있음

메시지 큐는 Command 기반의 메시지 브로커, 혹은 Event 기반의 이벤트 브로커 형태로 사용될 수 있으며 용도에 따라 기술 선택과 아키텍처 설계가 달라짐

# 3. 메세지 브로커와 이벤트 브로커
- 메세지 브로커는 서비스 간의 메세지 전달을 중개하며, 이벤트 브로커는 이벤트를 게시하고 구독하는 역할을 함
- 메세지 큐가 메세지 혹은 이벤트가 송신되고 수신되는 하나의 통신 통로라고 하면, **브로커**는 메세지 큐에 메세지 혹은 이벤트를 넣어주고 중개하는 역할을 하는 주체

## 메세지 브로커
- 메세지 브로커는 `메세지 지향 미들워어(Message-Oriented Middleware)`를 구현하는데 사용되는 시스템
- 메세지 브로커는 데이터를 보내고 처리하고 삭제하는 구조
- 어플리케이션간의 네트워크 데이터를 중계해주는 역할을 담당한다.
- 메세지 브로커는 이벤트 브로커의 기능을 하지 못함

## 이벤트 브로커
- 이벤트 브로커는 `이벤트 주도아키텍쳐(EDA- Event Driven Architecture)` 를 구현하는데 사용되는 시스템
- 이벤트 브로커는 이벤트라고 불리는 레코드를 보관하고 인덱스를 통해 개별 엑세스를 관리 할 수있음
- 또한 영구적으로 이벤트를 보존할수 있으며 이벤트 데이터를 브로커에 저장함으로 단일 진실 공급원으로 사용 가능하다.
- 이벤트 브로커 또한 기본적으로 메세지 브로커의 역할을 할 수 있음

## 차이점
- 레코드를 큐에 보관을 하느냐, 혹은 단순히 미들웨어 단에서 네트워크간 통신을 위해 데이터를 전달하고 삭제 하는 역할을 하는가에 따라 이벤트기반, 메세지기반 브로커로 분리 할 수 있음
- 메시지 브로커는 소비되면 삭제되지만, 이벤트 브로커는 영구 저장 가능
- 메시지 브로커는 명령을 전달 (주문 완료했으니 배송 처리 해줘)
- 이벤트 브로커는 상태 변화를 방송 (주문이 완료됐으니 알림, 추천, 통계 시스템이 이를 감지하고 각자 로직 수행)
- 결국 메세지기반에 중점을두고 처리하느냐 , 이벤트기반에 두고 데이터를 처리하느냐에 따라 다르게 분리됨
- 메세지큐는 Producer / Consumer 의 패턴을 사용하고, 이벤트큐는 Publisher / Subscriber 의 패턴을 사용
- 메시지 브로커는 1대1 처리, 이벤트 브로커는 1대 다수 처리로 주로 사용 (명령은 한명이 처리, 구독은 여러명이 처리)

|상황|선택|이유|
| --- | --- | --- |
|단일 작업 위임 (메일 전송, PDF 생성 등) |메시지 브로커|단순 Queue 처리로 충분|
|하나의 이벤트로 여러 시스템 반응해야 할 때	|이벤트 브로커	|Pub/Sub로 확장성 확보|
|재처리, 로그 보존이 중요한 경우	|이벤트 브로커|	Kafka 오프셋, 로그 기반|
|트랜잭션 흐름과 분리하고 싶을 때|	메시지 브로커| 트랜잭션 종속성 적음|

# 4. 메시지 브로커와 이벤트 브로커의 종류
