# 리밸런싱과 파티션 할당 전략

## 목차
1. 리밸런싱
2. 파티션 할당 전략
3. 적극적 리밸런싱
4. 협력적 리밸런싱
5. 4가지 파티션 할당 전략
   5-1. 레인지 파티션 할당 전략
   5-2. 라운드 로빈 파티션 할당 전략
   5-3. 스티키 파티션 할당 전략
   5-4. 협력적 스티키 파티션 할당 전략

# 1. 리밸런싱이란?
- 카프카 컨슈머는 토픽의 각 파티션에서 메시지를 처리하는 역할을 함
- 그런데 특정 컨슈머가 문제를 겪게 되면 그 컨슈머가 처리하던 파티션의 소유권을 다른 컨슈머로 넘겨야 함
- 이 과정을 리밸런싱이라고 부르며 아래 네가지 상황에서 주로 발생
  - 컨슈머 그룹에 새로운 컨슈머가 추가 될 때
  - 기존 컨슈머가 그룹에서 나갈 때
  - 구독하는 토픽에 새로운 파티션이 생길 때
  - 컨슈머가 구독하는 토픽이 변경될 때
- 리밸런싱이 가장 많이 일어나는 일반적인 상황은 애플리케이션 배포 시
- 기존 앱 종료 후 새로운 앱이 실행되면서 기존 컨슈머가 삭제되고 새로운 컨슈머가 생성되기 때문
  - 이 과정에서 리밸런싱이 최소 두번 이상 발생

### 리밸런싱의 문제점
- 리밸런싱이 진행되는 동안 컨슈머는 메시지를 처리하지 않음. 이로 인해 애플리케이션에서 지연 발생 가능
- 리밸런싱 과정에서 컨슈머가 파티션의 어느 위치부터 메시지를 읽어야 할지 결정 하는데, 이 과정에서 메시지가 중복되거나 누락될 수 있다
- 리밸런싱은 무거운 작업이기에 자주 발생되면 시스템에 부담이 될 수 있음

### 리밸런싱 관련해서 문제가 생기면?
- 불필요한 리밸런싱이 발생하지 않도록 예방
  - `max.poll.interval.ms` 값을 적절하게 설정
  - 메시지 처리 시간이 이 값을 초과하지 않도록 관리
  - Kafka가 "이 컨슈머는 죽었다"고 오판해서 리밸런싱을 일으키는 일을 방지할 수 있음
- 실제로 컨슈머가 죽거나, 스케일 인/아웃과 같은 상황에서 리밸런싱이 발생할 경우를 대비해 파티션 재할당의 부작용을 최소화
  - 스티키 할당 전략 또는 협력적 스티키 할당 전략(CooperativeStickyAssignor)을 설정
- 이 전략을 사용하면 전체 컨슈머가 중단되지 않고, 필요한 파티션만 이동하게 되어 리밸런싱 시간과 리소스를 줄일 수 있음
- 또한 메시지의 오프셋 커밋은 수동으로 관리(MANUAL_IMMEDIATE)하여 처리가 완료된 메시지만 커밋되도록 구성
- 만약 커밋 전에 서버가 죽거나 처리에 실패할 경우를 대비해, DB나 캐시에 저장할 때는 `messageId` 같은 고유 값을 기준으로 멱등성을 보장하는 로직을 추가
  - 중복 소비가 발생하더라도 실제 데이터 중복은 방지할 수 있는 구조로 설계하면 좋음

# 2. 파티션 할당 전략 (Partition Assignment Strategy)
- 파티션 할당 전략은 카프카 컨슈머가 토픽의 어떤 파티션을 소비할 것인지 결정하는 방식을 의미
- 이 전력에 따라 컨슈머와 파티션 간의 관계가 결정
- 데이터 처리 효율성과 성능에 큰 영향을 미침
- 크게 적극적 리밸런싱과 협력적 리밸런싱으로 나뉨
- 4가지의 파티션 전략이 존재
  - 레인지 파티션 할당 전략
  - 라운드 로빈 파티션 할당 전략
  - 스티키 파티션 할당 전략
  - 협력적 스티키 할당 전략

# 3. 적극적 리밸런싱(Eager Rebalance)
![image](https://github.com/user-attachments/assets/fea9a260-db8d-4271-b59b-e018d1399012)

- 레인지, 라운드 로빈, 스티키 파티션 할당 전략 이 해당하는 방식
- 리밸런싱이 일어나게 되면 모든 컨슈머는 아파치 카프카로부터 데이터 수신을 중단하고 자신들이 가지고 있던 파티션의 그룹 구성을 포기
- 이 과정에서 모든 컨슈머가 동시에 작업을 멈추는 'stop the world' 현상이 일어나게 되어 전체 컨슈머 그룹의 데이터 처리가 일시적으로 중단
- 이 시간 동안 컨슈머 그룹은 유휴 상태가 되어 메시지를 소비하거나 오프셋 커밋을 허용하지 않음
- 프로듀서의 경우에는 리밸런싱과 무관하게 파티션에 데이터를 계속해서 쓰기 때문에 대기 시간 동안 LAG가 급격하게 증가
  - 이로 인해 컨슈머 그룹의 데이터 처리 성능에 일시적인 영향을 미칠 수 있음
- 리밸런싱 이후 컨슈머들이 그룹에 다시 참여하고, 새로운 파티션을 할당 받음

### 주의할 점
- 컨슈머들이 이전에 가졌던 파티션을 반드시 다시 받는다는 보장이 없음
  - 리밸런싱 후에는 컨슈머들이 새로운 파티션을 할당받은 가능성이 있음
- 이러한 특성들로 인해 그룹의 안정성이나 데이터 처리 성능에 영향을 미칠 수 있으므로 신중하게 사용해야 함

# 4. 협력적 리밸런싱 (Cooperative Rebalance, Incremental Rebalance)
![image](https://github.com/user-attachments/assets/60f22fdc-ba99-4207-8427-b7a8f1757be9)

- 협력적 스티키 파티션 할당 전략이 해당하는 방식
- kafka v2.4 이후로 도입된 진보된 리밸런싱 방식
- 파티션의 일부만이 한 컨슈머에서 다른 컨슈머로 이동하는 특징을 가짐
- 리밸런싱과 직접적인 관련 없는 다른 카프카 컨슈머들이 데이터 처리를 계속 진행할 수 있게 함
  - 전체 그룹의 처리 성능에 미치는 영향을 최소화
- 협력적 리밸런싱은 안정적인 파티션 할당 상태를 점진적으로 찾아가는 과정으로, 여러 차례의 리밸런싱을 거침
- 첫 번째 단계에서는 리더가 모든 컨슈머에게 일부 파티션의 소유권을 잃게 될 것임을 알리고, 컨슈머는 이러한 파티션의 소유권을 포기
- 그 후 단계에서 coordinator는 이 고아가 된 파티션을 새로운 컨슈머에게 할당

- 이 방식은 안정적인 파티션 할당 상태가 이루어질 때까지 몇 번의 반복이 필요할 수 있음
- 그러나 적극적 리밸런싱에서 발생하는 서비스 중단 상황을 피할 수 있어 리밸런싱에 많은 시간이 소요되는 큰 규모의 컨슈머 그룹에서 중요함
- 전체 그룹의 성능을 유지하면서 파티션 할당을 유연하게 조절할 수 있는 장점이 존재
- 이 방식을 활용할 때에도 신중하게 접근하여 상황에 따라 적절한 전략을 선택하는 것이 중요


# 5. 4가지 파티션 할당 전략

## 5-1. 레인지(Range) 파티션 할당 전략
- 카프카 v2.4 이전까지는 기본으로 설정된 적극적 리밸런싱 방식의 파티션 할당 전략
![image](https://github.com/user-attachments/assets/759e652c-bcf9-41d9-8126-eb388620b0ba)

### 동작 순서
1. 먼저 구독 중인 토픽의 파티션과 컨슈머를 순서대로 나역
2. 각 컨슈머가 받아야 할 파티션의 수를 결정. 이는 해당 토픽의 전체 파티션 수를 컨슈머 그룹의 총 컨슈머 수로 나눈 값이다
3. 만약 컨슈머 수와 파티션 수가 정확히 일치한다면, 모든 컨슈머는 파티션을 균등하게 할당 받음
4. 그러나 파티션 수가 컨슈머 수로 균등하게 나누어 지지 않는다면 순서상 앞에 있는 컨슈머들이 추가로 파티션을 할당받음

### 장점
- 특정 도메인에 대한 데이터 처리를 한 컨슈머에서 일관되게 관리할 수 있음
  - 만약 토픽 A가 로그 데이터, 토픽 B가 해당 로그 데이터에 대한 에러 정보를 관리하는 경우
  - 동일한 파티션 번호를 가진 두 종류의 데이터가 동일한 컨슈머로 할당
  - 한 컨슈머 내에서 로그 데이터와 연관 에러 정보를 함께 처리하고 분석할 수 있어 데이터 일관성을 유지하고 처리 효율성을 높힐 수 있음

### 단점
- 파티션의 분배가 균등하지 않을 수 있음
- 특정 컨슈머가 과부하를 겪을 수 있음
- 새로운 컨슈머가 그룹에 참여하거나 기존 컨슈머가 그룹에서 나가면 전체적인 리밸런싱이 발생하여 잠시동안 모든 컨슈머가 작업을 중단

## 5-2. 라운드 로빈(Round Robin) 파티션 할당 전략
- 적극적 리밸런싱 방식의 파티션 할당 전략 중 하나
- 파티션을 컨슈머 그룹의 모든 컨슈머에게 균등하게 분배하는 방식
- 레인지 전략과 마찬가지로, 파티션과 컨슈머는 할당 전에 사전식 순서로 정렬

![image](https://github.com/user-attachments/assets/3833a364-f01c-483f-9a96-99161b62679d)

### 장점
- 모든 사용 가능한 컨슈머를 효과적으로 활용하고 성능을 향상시킬 수 있음
  - 모든 컨슈머가 균등하게 작업을 분산받아 처리하게 되므로 효율적인 리소스 활용 가능

### 단점
- 컨슈머 수가 변경될 때 (리밸런싱 발생 시) 파티션 이동을 최소화 하려는 시도를 하지 않음
  - 불필요한 파티션 이동은 새로운 파티션의 데이터를 불러오고 처리하는 데 추가적인 시간과 리소스가 소요되므로 컨슈머 성능에 부정적인 영향을 미침

## 5-3. 스티키(Sticky) 파티션 할당 전략
- 적극적 리밸런싱 방식의 파티션 할당 전략 중 하나
- 리밸런싱 작업이 필요할 때, 리밸런싱 작업이 일어나기 전의 컨슈머의 파티션 정보를 우선적으로 매핑하여 리밸런싱 과정에서 발생할 수 있는 불필요한 파티션 이동을 최소화 함
![image](https://github.com/user-attachments/assets/82a50ff2-e66b-4909-9905-aa356b7fe964)

- 불필요한 파티션 이동을 최소화 하고 균형잡힌 처리량을 유지하면서 효율적인 리밸런싱이 가능하게 함
- 이 전략이 적용되는 환경에서는 파티션의 균형과 리밸런싱 과정의 효율성이 중요한 요소

## 장점
- 이 방식은 라운드 로빈 할당 전략에서 발생할 수 있는 불필요한 파티션 이동 문제를 개선
- 파티션 이동을 최소화 하면서도 사용 가능한 컨슈머 간에 가능한 한 균형 잡힌 할당을 유지 
  - 예를 들어 위 이미지에서 컨슈머 2 다운 -> 컨슈머 1,3은 기존 파티션을 그대로 유지
  - 컨슈머 2가 가진 파티션은 새로운 컨슈머 3에게 할당
  - 불필요한 파티션 이동을 최소화하고 균형 유지
- 그러나 스티키 파티션 할당 전략이 항상 기존의 파티션과 컨슈머를 유지하는 것은 아님
  - 이 전략의 최우선 순위는 가능한 균형 잡힌 파티션 할당을 유지하는 것
  - 그 다음 목표가 리밸런싱 발생할 때 기존 할당된 파티션 정보를 최대한 유지하는 것이기 때문

## 5-4. 협력적 스티키(Cooperative Sticky) 파티션 할당 전략
- 기존의 스티키 할당 전략에 협력적 리밸런싱이라는 새로운 개념을 추가한 것
- 전체 컨슈머 그룹이 아닌 개별 컨슈머에 초점을 맞춰 더욱 유연하고 효율적인 리밸런싱을 가능하게 함
- 카프카 v2.4부터 Default

- 리밸런싱이 필요한 특정 파티션에만 집중하여 그 외 나머지 파티션들은 그대로 유지되는 방식
- 컨슈머 재할당이 필요한 특정 파티션의 소비만 중지하고, 다른 나머지 파티션에서는 계속해서 데이터를 소비함
- 전체 컨슈머 그룹이 아닌 개별 컨슈머의 작업 중단을 최소화 하므로 전체적인 데이터 처리 성능에 더 적은 영향을 미침
- 컨슈머가 재할당 되지 않은 파티션에서 계속해서 데이터를 소비할 수 있도록 지원하며, 이로 인해 리밸런싱의 영향을 최소화 하면서 효율적인 리밸런싱을 가능하게 함

![image](https://github.com/user-attachments/assets/cd951db6-1aba-4709-9f72-1b1abf787d6c)

- 이미지 위쪽은 컨슈머 추가, 아래는 컨슈머 제거 상황
- 협력적 스티키 전략은 컨슈머 그룹의 구성 변경이 자주 발생하는 환경에 특히 유용
- 컨슈머의 추가나 제거 또는 파티션의 재할당이 필요한 상황에서도 이 전략은 빠르게 적응하여 효율적인 리밸런싱을 수행
- 동적 멤버십과 정적 멤버십 모두를 지원하며 애플리케이션의 요구사항에 따라 컨슈머 그룹의 구성을 동적으로 유연하게 조정 가능
- 협력적 스티키 파티션 할당 전략은 리밸런싱 과정에서 데이터 처리 지연을 최소화하며, 빠르고 효율적인 리밸런싱을 가능하게 하여 전체적인 컨슈머 그룹의 성능 향상과 안정성을 지원


# 정리
|리밸런싱 방식|설명|영향 범위|적용 전략|
| --- | --- | --- | --- |
| 적극적 리밸런싱(EAGER)| 리밸런싱 발생 시 모든 컨슈머가 데이터 수신을 중단하고 파티션의 소유권을 포기|전체 컨슈머 그룹|Range, RoundRobin,Sticky|
| 협력적 리밸런싱(COOPERATIVE)| - 리밸런싱이 필요한 특정 파티션에만 영향을 주며, 그 외의 파티션들은 그대로 유지.<br> - 개별 컨슈머의 작업 중단을 최소화| 특정 파티션 | Cooperative Sticky|

|파티션 할당 전략	|설명	|Rebalancing Protocol|
| --- | --- | --- |
|Range Partition 할당 전략|	Topic 별로 동일한 Partition을 특정 Consumer에게 할당하는 방식	|EAGER
Round Robin Partition 할당 전략|	사용 가능한 Partition과 Consumer를 순차적으로 할당|	EAGER|
Sticky Partition 할당 전략	|Consumer가 구독 중인 Partition을 계속 유지하게 끔 할당	|EAGER|
|Cooperative Sticky Partition 할당 전략|	Sticky와 유사하지만, 전체 Rebalancing이 아닌 필요한 Partition끼리 점진적으로 Rebalancing 하는 방식|	COOPERATIVE|

## Ref
- https://dkswnkk.tistory.com/736#4.-%ED%98%91%EB%A0%A5%EC%A0%81-%EC%8A%A4%ED%8B%B0%ED%82%A4-%ED%8C%8C%ED%8B%B0%EC%85%98-%ED%95%A0%EB%8B%B9-%EC%A0%84%EB%9E%B5
